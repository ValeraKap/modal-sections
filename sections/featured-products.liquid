{%- liquid
  assign enabled = section.settings.enable
  assign show_once = section.settings.show_only_once_per_customer
  assign modal_heading = section.settings.heading | default: 'Complete your purchase'
  assign modal_image = section.settings.image
  assign products_list = section.settings.products
-%}

{%- if enabled and products_list.count > 0 -%}
  {{ 'section-featured-products.css' | asset_url | stylesheet_tag }}
  <script src="{{ 'featured-products.js' | asset_url }}" defer="defer"></script>

  <featured-products-modal
    id="FeaturedProductsModal-{{ section.id }}"
    data-section-id="{{ section.id }}"
    data-show-once="{{ show_once }}"
    class="featured-products-modal"
  >
    <modal-dialog class="featured-products-modal__dialog">
            <div
              role="dialog"
              aria-modal="true"
              aria-label="{{ modal_heading }}"
              class="featured-products-modal__content"
              tabindex="-1"
            >
              <button
                type="button"
                class="featured-products-modal__close featured-products-modal__close--mobile"
                aria-label="{{ 'accessibility.close' | t }}"
              >
                <span class="svg-wrapper">
                  {{- 'icon-close.svg' | inline_asset_content -}}
                </span>
              </button>
              <div class="featured-products-modal__inner">
          <div class="featured-products-modal__image-wrapper">
            {%- if modal_image != blank -%}
              <img
                src="{{ modal_image | image_url: width: 800 }}"
                alt="{{ modal_image.alt | escape }}"
                width="800"
                height="{{ 800 | divided_by: modal_image.aspect_ratio | ceil }}"
                loading="lazy"
                class="featured-products-modal__image"
              >
            {%- else -%}
              <div class="featured-products-modal__image-placeholder">
                <span class="visually-hidden">{{ 'products.product.image' | t }}</span>
              </div>
            {%- endif -%}
          </div>

          <div class="featured-products-modal__content-wrapper">
            <div class="featured-products-modal__header">
              <h2 class="featured-products-modal__heading">{{ modal_heading }}</h2>
              <button
                type="button"
                class="featured-products-modal__close"
                aria-label="{{ 'accessibility.close' | t }}"
              >
                <span class="svg-wrapper">
                  {{- 'icon-close.svg' | inline_asset_content -}}
                </span>
              </button>
            </div>
            <div class="featured-products-modal__intro">
              <p class="featured-products-modal__intro-text" data-intro-text></p>
              <p class="featured-products-modal__intro-savings" data-intro-savings></p>
            </div>

            <div class="featured-products-modal__products">
              {%- for product in products_list -%}
                {%- assign variant = product.selected_or_first_available_variant -%}
                {%- if variant.available -%}
                  <div
                    class="featured-products-modal__product"
                    data-product-id="{{ product.id }}"
                    data-product-handle="{{ product.handle }}"
                  >
                    <div class="featured-products-modal__product-image">
                      {%- if product.featured_image -%}
                        <img
                          src="{{ product.featured_image | image_url: width: 140 }}"
                          alt="{{ product.featured_image.alt | escape }}"
                          width="140"
                          height="{{ 140 | divided_by: product.featured_image.aspect_ratio | ceil }}"
                          loading="lazy"
                        >
                      {%- else -%}
                        {{ 'product-apparel-1' | placeholder_svg_tag: 'placeholder-svg' }}
                      {%- endif -%}
                    </div>
                    <div class="featured-products-modal__product-info">
                      <div class="featured-products-modal__product-title-wrapper">
                        <h3 class="featured-products-modal__product-title">{{ product.title | escape }}</h3>
                        {%- liquid
                          # First check metafield for short description
                          assign short_description = product.metafields.custom.short_description.value
                          
                          # If metafield is empty, get text from description
                          if short_description == blank and product.description != blank
                            assign description_text = product.description | strip_html | strip
                            # Limit to ~33 characters
                            if description_text.size > 33
                              assign short_description = description_text | truncate: 33, ''
                              assign short_description = short_description | append: '...'
                            else
                              assign short_description = description_text
                            endif
                          endif
                        -%}
                        {%- if short_description != blank -%}
                          <p class="featured-products-modal__product-description">
                            {{ short_description }}
                          </p>
                        {%- endif -%}
                      </div>
                      {%- if variant.sku != blank -%}
                        <p class="featured-products-modal__product-sku">
                          {{ 'products.product.sku' | t }}: {{ variant.sku }}
                        </p>
                      {%- endif -%}
                      <div class="featured-products-modal__product-price">
                        {%- liquid
                          assign current_price = variant.price
                          assign compare_price = variant.compare_at_price
                          # Format prices with two decimal places
                          assign current_price_formatted = current_price | money
                          assign compare_price_formatted = compare_price | money
                        -%}
                        {%- if compare_price > current_price -%}
                          <span class="featured-products-modal__price-current">{{ current_price_formatted }}</span>
                          <span class="featured-products-modal__price-compare">{{ compare_price_formatted }}</span>
                        {%- else -%}
                          <span class="featured-products-modal__price-current">{{ current_price_formatted }}</span>
                        {%- endif -%}
                      </div>
                    </div>
                  </div>
                {%- endif -%}
              {%- endfor -%}
            </div>

            <div class="featured-products-modal__buttons">
              <button
                type="button"
                class="featured-products-modal__button featured-products-modal__button--primary button button--primary"
                data-add-to-cart
              >
                {{ 'products.product.add_to_cart' | t }}
              </button>
              <a
                href="{{ routes.cart_url }}"
                class="featured-products-modal__button featured-products-modal__button--secondary button button--secondary"
                data-continue-to-cart
              >
                {{ 'products.product.continue_to_cart' | t }}
              </a>
            </div>
          </div>
        </div>
      </div>
    </modal-dialog>
  </featured-products-modal>

  <script type="application/json" id="FeaturedProductsData-{{ section.id }}">
    {
          "products": [
            {%- for product in products_list -%}
              {%- assign variant = product.selected_or_first_available_variant -%}
              {
                "id": {{ product.id | json }},
                "handle": {{ product.handle | json }},
                "title": {{ product.title | json }},
                "variant_id": {{ variant.id | json }},
                "price": {{ variant.price | json }},
                "compare_at_price": {{ variant.compare_at_price | json }},
                "available": {{ variant.available | json }},
                "sku": {{ variant.sku | json }}
              }{%- unless forloop.last -%},{%- endunless -%}
            {%- endfor -%}
          ],
      "image": {% if modal_image %}{{ modal_image | image_url: width: 800 | json }}{% else %}null{% endif %}
    }
  </script>
{%- endif -%}

{% schema %}
{
  "name": "Featured products",
  "tag": "section",
  "class": "section section-featured-products",
  "settings": [
    {
      "type": "checkbox",
      "id": "enable",
      "label": "Enable modal",
      "default": true
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "COMPLETE YOUR PURCHASE"
    },
    {
      "type": "image_picker",
      "id": "image",
      "label": "Image",
      "info": "If empty, product image will be used"
    },
    {
      "type": "checkbox",
      "id": "show_only_once_per_customer",
      "label": "Show only once per customer",
      "default": false,
      "info": "Modal will be shown only once per browser session"
    },
    {
      "type": "product_list",
      "id": "products",
      "label": "Products",
      "limit": 10
    }
  ],
  "presets": [
    {
      "name": "Featured products"
    }
  ]
}
{% endschema %}
